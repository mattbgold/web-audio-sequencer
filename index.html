<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>web sequencer</title>
<link href="main.css" rel="stylesheet" type="text/css">
</head>

<body>
<div>Snap Width: <input type="range" min="0" max="4" data-bind="value: snapMode" /> Zoom:  <input type="range" min="1" max="4" data-bind="value: zoomLevel" /></div>

<div class="roll" oncontextmenu="return false;">
	<!-- ko foreach: tracks -->
	<div class="track" data-bind="event: { mousedown: trackClicked }, css: $root.trackZoomClass"></div>
	<!-- /ko -->
	<!-- ko foreach: notes -->
	<div class="note" data-bind="event: { mousemove: $root.removeNote, mousedown: $root.removeNote }, draggableGrid: $root.gridSnapWidth, style: { width: (len*$root.gridBaseWidth()).toString() +'px', left: (on*$root.gridBaseWidth()).toString() + 'px', top: (top*trackHeight).toString() + 'px' }"></div>
	<!-- /ko -->
</div>



<script src="Scripts/bufferLoader.js"></script>
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.3.0/knockout-min.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
<script>
	var context;
	trackHeight = 20;
	mouseRight = false;
	$(function() {
		try {
			window.AudioContext = window.AudioContext || window.webkitAudioContext;
			context = new AudioContext();
		}
		catch(e) {
			alert('Web Audio API is not supported in this browser');
		}
		
		/* var file = prompt('Paste a link to a sound file');
		
		bufferLoader = new BufferLoader( context, [file], function(bufferList) {
			var source1 = context.createBufferSource();
			source1.buffer = bufferList[0];
			source1.connect(context.destination);
			source1.start(0);
		});

		bufferLoader.load();*/ 
		
		$(document).mousedown(function(e){
			// Left mouse button was pressed, set flag
			if(e.which === 3) mouseRight = true;
			if(e.which === 1) mouseLeft = true;
		});
		$(document).mouseup(function(e){
			// Left mouse button was released, clear flag
			if(e.which === 3) mouseRight = false;
			if(e.which === 1) mouseLeft = false;
		});
	});
	
	var ViewModel = function() {
		var self = this;
		
		self.snapMode = ko.observable(1);
		self.gridResolution = ko.computed(function() {
			return Math.pow(2, self.snapMode());
		});
		self.zoomLevel = ko.observable(3);
		
		//quarter note width. need to make this smallest possible length
		self.gridBaseWidth = ko.computed(function(){
			var w = 40;
			for(var i = 1; i < (5-self.zoomLevel()); i++) {
				w/=2;
			}
			return w;
		});
		
		self.gridSnapWidth = ko.computed(function() {
			return self.gridResolution()*self.gridBaseWidth();
		});
		
		self.tracks = [];
		self.notes = ko.observableArray([]);
		
		for(var i=0; i< 20; i++) {
			self.tracks.push({ num: i});
		}
		
		// functions
		self.trackZoomClass = ko.pureComputed(function() {
			return 'track-' + self.zoomLevel();
		});
		
		self.removeNote = function($data, event) {
			if(mouseRight || (event.type === 'mousedown' && event.which ===3)) {
				self.notes.remove($data);
			}
		};
	};

	var trackClicked = function(data, event) {
		if(event.which !== 1) {
			return false;
		}
		var $track = $(event.target);
		var offset = $track.offset();
		var trackClickX = event.clientX - offset.left;
		var trackXSnap = (Math.floor(trackClickX / viewModel.gridSnapWidth())*viewModel.gridSnapWidth())/viewModel.gridBaseWidth();

		var newNote = {on: trackXSnap, len: viewModel.gridResolution(), top: data.num};
		viewModel.notes.push(newNote);
		
		//retrigger event to start dragging
		setTimeout(function(){if(mouseLeft){$('.note').last().trigger(event);}}, 100);
	};
	
	ko.bindingHandlers.draggableGrid = {
		init: function(element, valueAccessor, allBindings, noteModel, bindingContext) {
			var model = bindingContext.$root;
			$(element).draggable({grid: [ ko.utils.unwrapObservable(valueAccessor()), trackHeight ], containment: "parent", 
				stop: function(e, ui) {
					noteModel.on = ui.position.left/model.gridBaseWidth();
					noteModel.top = ui.position.top/trackHeight;
				}
			});
			$(element).resizable({grid: ko.utils.unwrapObservable(valueAccessor()), handles: 'e', containment: "parent", 
				stop: function(e, ui) {
					noteModel.len = ui.size.width/model.gridBaseWidth();
				}
			});
			
		},
		update: function(element, valueAccessor, allBindings, viewModel) {
			$(element).draggable("option", "grid", [ ko.utils.unwrapObservable(valueAccessor()), trackHeight ]);
			$(element).resizable("option", "grid", ko.utils.unwrapObservable(valueAccessor()));
		}
	};
	
	var viewModel = new ViewModel();
	ko.applyBindings(viewModel);
	
	
</script>
</body>
</html>

