<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>web sequencer</title>
<link href="main.css" rel="stylesheet" type="text/css">
</head>

<body>
<div>Snap Width: <span data-bind="text:snapLengthText"></span><input type="range" min="0" max="4" data-bind="value: snapMode" /> Zoom: <span data-bind="text:zoomLevel"></span> <input type="range" min="1" max="5" data-bind="value: zoomLevel" /></div>
<div>BPM: <input type="text" data-bind="value: bpm"/><button type="button" data-bind="click: play, enable: loaded">Play</button><button type="button" data-bind="click: stop">Stop</button> 
</div>

<div class="keys"></div>
<div class="roll" oncontextmenu="return false;" data-bind="css: actionCursor">
	<!-- ko foreach: tracks -->
	<div class="track" data-bind="event: { mousedown: $root.trackClicked }, css: $root.trackZoomClass"></div>
	<!-- /ko -->
	<!-- ko foreach: notes -->
	<div class="note" data-bind="gridNote: $root.gridSnapWidth, css: { 'is-note-selected': isSelected }"></div>
	<!-- /ko -->
</div>

<!-- polyfill -->
<script src="./inc/shim/Base64.js" type="text/javascript"></script>
<script src="./inc/shim/Base64binary.js" type="text/javascript"></script>
<script src="./inc/shim/WebAudioAPI.js" type="text/javascript"></script>
<!-- midi.js package -->
<script src="./js/midi/audioDetect.js" type="text/javascript"></script>
<script src="./js/midi/gm.js" type="text/javascript"></script>
<script src="./js/midi/loader.js" type="text/javascript"></script>
<script src="./js/midi/plugin.audiotag.js" type="text/javascript"></script>
<script src="./js/midi/plugin.webaudio.js" type="text/javascript"></script>
<script src="./js/midi/plugin.webmidi.js" type="text/javascript"></script>
<!-- utils -->
<script src="./js/util/dom_request_xhr.js" type="text/javascript"></script>
<script src="./js/util/dom_request_script.js" type="text/javascript"></script>

<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.3.0/knockout-min.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>

<script src="./js/jquery.hotkeys.js"></script>

<script src="./js/Muzart.js"></script>
<script src="./js/PianoRollModel.js"></script>
<script src="./js/BindingHandlers.js"></script>
<script>
	var trackHeight = 20;
	var mouseRight = false;
	var mouseLeft = false;
	var inputs = {
		ctrl: ko.observable(false),
		shift: ko.observable(false),
		alt: ko.observable(false)
	};
	dp=false;

	//TODO: move all piano roll stuff into Piano roll component
	$(function() {
		$(document).mousedown(function(e) {
			if(e.which === 3) mouseRight = true;
			if(e.which === 1) mouseLeft = true;
		});
		$(document).mouseup(function(e) {
			if(e.which === 3) mouseRight = false;
			if(e.which === 1) mouseLeft = false;
		});
		$(document).on('keyup keydown', function(e){ inputs.shift(e.shiftKey);});
		$(document).on('keyup keydown', function(e){ inputs.ctrl(e.ctrlKey);});
		$(document).on('keyup keydown', function(e){ inputs.alt(e.altKey);});
		//TODO: use this plugin to implement copy/paste/delete/ and more
		$(document).bind('keydown', 'ctrl+a', viewModel.selectAll);
		$(document).bind('keydown', 'ctrl+d', viewModel.deselectAll);
		$(document).bind('keydown', 'delete', viewModel.deleteSelection);
		$(document).bind('keydown', 'backspace', viewModel.deleteSelection);
		$(document).bind('keydown', 'ctrl+c', viewModel.copySelection);
		$(document).bind('keydown', 'ctrl+v', viewModel.pasteSelection);

		MIDI.loadPlugin({
			soundfontUrl: "./soundfont/",
			instrument: "acoustic_grand_piano",
			onprogress: function(state, progress) {
				console.log(state, progress);
			},
			onsuccess: function() {
				viewModel.loaded(true);
			}
		});
	});
	
	var viewModel = new Muzart.PianoRollModel(MIDI);
	ko.applyBindings(viewModel);
</script>
</body>
</html>

