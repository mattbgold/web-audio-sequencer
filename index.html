<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>web sequencer</title>
<link href="main.css" rel="stylesheet" type="text/css">
</head>

<body>
<div>Snap Width: <span data-bind="text:snapLengthText"></span><input type="range" min="0" max="4" data-bind="value: snapMode" /> Zoom: <span data-bind="text:zoomLevel"></span> <input type="range" min="1" max="5" data-bind="value: zoomLevel" /></div>
<div>BPM: <input type="text" data-bind="value: bpm"/><button type="button" data-bind="click: play, enable: loaded">Play</button><button type="button" data-bind="click: stop">Stop</button> 
</div>

<div class="keys"></div>
<div class="roll" oncontextmenu="return false;" data-bind="css: actionCursor">
	<!-- ko foreach: tracks -->
	<div class="track" data-bind="event: { mousedown: $root.trackClicked }, css: $root.trackZoomClass"></div>
	<!-- /ko -->
	<!-- ko foreach: notes -->
	<div class="note" data-bind="gridNote: $root.gridSnapWidth, css: { 'is-note-selected': isSelected }"></div>
	<!-- /ko -->
	<div class="box-select" data-bind="boxSelect: onBoxSelect"></div>
</div>

<!-- polyfill -->
<script src="./inc/shim/Base64.js" type="text/javascript"></script>
<script src="./inc/shim/Base64binary.js" type="text/javascript"></script>
<script src="./inc/shim/WebAudioAPI.js" type="text/javascript"></script>
<script src="./inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
<!-- jasmid package -->
<script src="./inc/jasmid/stream.js"></script>
<script src="./inc/jasmid/midifile.js"></script>
<script src="./inc/jasmid/replayer.js"></script>
<!-- midi.js package -->
<script src="./js/midi/audioDetect.js" type="text/javascript"></script>
<script src="./js/midi/gm.js" type="text/javascript"></script>
<script src="./js/midi/loader.js" type="text/javascript"></script>
<script src="./js/midi/plugin.audiotag.js" type="text/javascript"></script>
<script src="./js/midi/plugin.webaudio.js" type="text/javascript"></script>
<script src="./js/midi/plugin.webmidi.js" type="text/javascript"></script>
<script src="./js/midi/player.js" type="text/javascript"></script>
<!-- utils -->
<script src="./js/util/dom_request_xhr.js" type="text/javascript"></script>
<script src="./js/util/dom_request_script.js" type="text/javascript"></script>

<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.3.0/knockout-min.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>

<script src="./js/jquery.hotkeys.js"></script>

<script src="./js/Muzart.js"></script>
<script src="./js/PianoRollModel.js"></script>
<script src="./js/BindingHandlers.js"></script>
<script>
	var trackHeight = 20;
	var mouseRight = false;
	var mouseLeft = false;
	var inputs = {
		ctrl: ko.observable(false),
		shift: ko.observable(false),
		alt: ko.observable(false)
	};
	dp=false;

	//TODO: move all piano roll stuff into Piano roll component
	$(function() {
		$(document).mousedown(function(e) {
			if(e.which === 3) mouseRight = true;
			if(e.which === 1) mouseLeft = true;
		});
		$(document).mouseup(function(e) {
			if(e.which === 3) mouseRight = false;
			if(e.which === 1) mouseLeft = false;
		});
		$(document).on('keyup keydown', function(e){ inputs.shift(e.shiftKey);});
		$(document).on('keyup keydown', function(e){ inputs.ctrl(e.ctrlKey);});
		$(document).on('keyup keydown', function(e){ inputs.alt(e.altKey);});
		//TODO: make sure these get encapsulated in the piano roll component, or rather, set up a way to wire different handlers to these hotkeys depending on context
		$(document).bind('keydown', 'ctrl+a', viewModel.selectAll);
		$(document).bind('keydown', 'ctrl+d', viewModel.deselectAll);
		$(document).bind('keydown', 'del', viewModel.deleteSelection);
		$(document).bind('keydown', 'backspace', viewModel.deleteSelection);
		$(document).bind('keydown', 'ctrl+c', viewModel.copySelection);
		$(document).bind('keydown', 'ctrl+x', viewModel.cutSelection);
		$(document).bind('keydown', 'ctrl+v', viewModel.pasteSelection);
		$(document).bind('keydown', 'space', viewModel.togglePlay);

		MIDI.loadPlugin({
			soundfontUrl: "./soundfont/",
			instrument: "acoustic_grand_piano", //acoustic_grand_piano
			onprogress: function(state, progress) {
				console.log(state, progress);
			},
			onsuccess: function() {
				viewModel.loaded(true);
				
				player = MIDI.Player;
				player.timeWarp = 1;
				player.loadFile('data:audio/midi;base64,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',
				function() {
						//alert('loaded');
						var offset = 0;
						var currentTime=0;
						var queuedTime = 0;
						var muzartNotes = [];
						for(var i=0; i< player.data.length; i++) {
							var obj = player.data[i];
							if ((queuedTime += obj[1]) <= currentTime) {
								offset = queuedTime;
								continue;
							}
							currentTime = queuedTime - offset;
							var event = obj[0].event;
							if (event.type !== 'channel') {
								continue;
							}
							
							var queueTime = queuedTime - offset;
							switch (event.subtype) {
								case 'noteOn':
									muzartNotes.push(new Muzart.Note(108-event.noteNumber, (queueTime/1000)*(viewModel.baseNotesToMakeQuarterNote)* (viewModel.bpm()/60), 4, event.velocity));
									break;
								case 'noteOff':
									break;
								default:
									break;
							}
						}
						viewModel.notes(muzartNotes);
					});
			}
		});
	});
	
	var viewModel = new Muzart.PianoRollModel(MIDI);
	ko.applyBindings(viewModel);
</script>
</body>
</html>

